name: Backup Supabase Database

on:
  schedule:
    - cron: '0 0 * * *' # Every day at midnight UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Backup Directory
        run: |
          TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
          BACKUP_DIR="database/backups/full_${TIMESTAMP}"
          mkdir -p "${BACKUP_DIR}"
          echo "BACKUP_DIR=${BACKUP_DIR}" >> $GITHUB_ENV

      - name: Backup Tables
        env:
          # Try multiple secret names to be robust
          SUPABASE_URL_1: ${{ secrets.SUPABASE_URL }}
          SUPABASE_URL_2: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_KEY_1: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY_2: ${{ secrets.NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY_3: ${{ secrets.SUPABASE_KEY }}
        run: |
          # Determine SUPABASE_URL
          if [ -n "$SUPABASE_URL_1" ]; then
            SUPABASE_URL="$SUPABASE_URL_1"
          elif [ -n "$SUPABASE_URL_2" ]; then
            SUPABASE_URL="$SUPABASE_URL_2"
          else
            echo "::error::SUPABASE_URL or NEXT_PUBLIC_SUPABASE_URL secret is not set in GitHub repository settings."
            exit 1
          fi
          
          # Determine SUPABASE_KEY
          if [ -n "$SUPABASE_KEY_1" ]; then
            SUPABASE_KEY="$SUPABASE_KEY_1"
          elif [ -n "$SUPABASE_KEY_2" ]; then
            SUPABASE_KEY="$SUPABASE_KEY_2"
          elif [ -n "$SUPABASE_KEY_3" ]; then
            SUPABASE_KEY="$SUPABASE_KEY_3"
          else
            echo "::error::SUPABASE_SERVICE_ROLE_KEY or NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY secret is not set in GitHub repository settings."
            exit 1
          fi

          TABLES=("profiles" "registration_requests" "announcements" "user_read_announcements" "user_balances" "deposit_transactions" "crypto_wallets" "notifications" "blacklist" "shop_services" "purchases" "device_login_attempts" "teams")
          
          for TABLE in "${TABLES[@]}"; do
            echo "Backing up table: ${TABLE}"
            # Ensure URL doesn't have trailing slash
            CleanURL=${SUPABASE_URL%/}
            
            HTTP_CODE=$(curl -s -o "${BACKUP_DIR}/${TABLE}.json" -w "%{http_code}" -X GET "${CleanURL}/rest/v1/${TABLE}?select=*" \
              -H "apikey: ${SUPABASE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_KEY}")
            
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "::warning::Failed to backup ${TABLE}. HTTP status: ${HTTP_CODE}"
              # Check if file is empty or contains error
              if [ -f "${BACKUP_DIR}/${TABLE}.json" ]; then
                cat "${BACKUP_DIR}/${TABLE}.json"
              fi
            else
              echo "Successfully backed up ${TABLE}"
            fi
          done

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add database/backups/
          git commit -m "chore: automatic database backup $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push origin main
